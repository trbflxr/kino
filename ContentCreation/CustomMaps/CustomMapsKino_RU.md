# Создание карт для Kino

## Установка Unity и Content SDK

Если у вас всё ещё не установлен Unity, то установите его используя [этот гайд](../Tools/UnityInstallation_RU.md).

Если у вас не был установлен **Content SDK**, то [установите и настройте его](../Tools/SDKInstall_RU.md). Или же [обновите](../Tools/SDKUpdate_RU.md) **Content SDK**, если он уже был у вас установлен.


> [!NOTE]  
> В папке `Assets/Content/Maps/Example` есть пример карты и вы можете с ним ознакомиться.

## Подготовка структуры проекта

Предполагается, что все карты должны находиться в папке `Assets/Content/Maps`.

Каждая карта должна находится в **своей** папке. Это повысит удобство и ускорит создание.

Пример структуры:

```
📂 Assets
 └ 📁 Content
    └ 📁 Maps
       └ 📁 Example
       └ 📁 MyMap1
       └ 📁 MyMap2
```

> [!IMPORTANT]  
> Создавайте новую папку в `Maps` для каждой новой карты.

## Создание метаданных карты

> [!IMPORTANT]  
> В данном примере будет использовано карты `Example`. Вы же называйте карту как хотите.

Для каждой новой карты необходимо создать **файл метаданных**. Для этого создайте и перейдите в папку новой карты. После чего создайте файл метаданных с помощью **контекстного меню**.

![map_meta_create.png](../Images/Maps/maps_meta_create.png)

Структура должна выглядеть следующим образом:

```
📂 Maps
 └ 📁 Example
    └ 📄 __map_meta
```

## Заполнение метаданных карты

Заполните метаданные о карте. Это нужно сделать **один раз** для **каждой** новой карты.

![maps_meta_fill.png](../Images/Maps/maps_meta_fill.png)

Самым важным полем является **Name**, это и есть название карты, оно должно быть уникальным.

Поле **Version** отвечает за версию карты, пока что оставьте его как есть, со значением `100`.

В поле **Load Screen** укажите экран загрузки в формате `.png` или `.jpg`. Изображение должно находится в папке с картой.

Поле **Scene** пока оставьте пустым, его нужно будет заполнить после [создания сцены](#создание-сцены).

## Создание сцены

Каждая карта подставляет собой сцену, на которой могут находиться любые объекты, источники света и т.д.

Для создания сцены кликните правой кнопкой в окне **Project**, затем выберете **Create** и **Scene**. Сцену можете назвать как угодно, но только на **английском** языке и **без пробелов**.

![maps_scene_create.png](../Images/Maps/maps_scene_create.png)

После создания сцены нужно дозаполнить метаданные карты. Укажите только что созданную сцену в поле **Scene**, после чего нажмите **Validate all**, что бы удостовериться в правильности метаданных.

![maps_meta_fill_scene.png](../Images/Maps/maps_meta_fill_scene.png)

## Настройка Blender интеграции

> [!WARNING]  
> Если вы не используете Blender, или хотите использовать `.fbx` модели, то можете пропустить этот шаг.
> Информацию об импорте моделей из выбранного вами софта нейдите в интернете.
> Процесс импорта моделей [описан ниже](#импорт-blend--fbx-файлов-в-unity).

Настройка интеграции **Blender** описана в [этом гайде](../Tools/BlenderIntegration_RU.md).

## Импорт .blend / .fbx файлов в Unity

> [!WARNING]  
> Если вы хотите добавлять модели в виде `.fbx` файлов, то убедитесь, что в настройках экспорта у вас установлены выделенные на скриншоте параметры.
> В поле `Path Mode` должно быть установлено **Copy**, а так же `Forward` и `Up` в секции `Transform` должны быть установлены как на примере.

> [!IMPORTANT]  
> Модель экспортируйте в папку карты над которой работаете, рядом с файлом метаданных `__map_meta`. Таким образом Unity увидит текстуры и модель без каких-либо дополнительных действий.

```
📂 Assets
 └ 📁 Content
    └ 📁 Maps
       └ 📁 Example
          └ 📁 your_model_name.fbm   <- эту папку создаст Blender, там лежат текстуры для модели
          └ 📄 __map_meta
          └ 📄 your_model_name.fbx   <- вот сюда
```

![blender_export_fbx.png](../Images/Blender/blender_export_fbx.png)

## Добавление моделей на сцену

Откройте сцену карты, которую создали ранее. Для этого дабл кликните по ней в **списке файлов** окна **Project**.

Перетащите ваш `.blend`, `.fbx` или любую другую модель на сцену.

Если модель выглядит некорректно, или вы хотите более точно её настроить, то необходимо распаковать префаб.

![maps_prefab_unpack.png](../Images/Maps/maps_prefab_unpack.png)

Так же если вы хотите дополнительно настроить или исправить материалы, то нужно их распаковать.

Для этого выберите файл модели в окне **Project**, затем в его свойствах выберите **Materials** -> **Extract Materials**, как это показано на примере.

Затем укажите папку куда хотите их распаковать. После чего можете настроить материалы.

![maps_extract_materials.png](../Images/Maps/maps_extract_materials.png)

## Настройка освещения и постобработки

### Солнце

Если на сцене нет `Directional Light`, то нужно его добавить с помощью контекстного меню.

Для этого в окне `Hierarcy` нажмите **ПКМ** на пустом месте и выберите `Light` -> `Directional Light`, после можете настроить источник света.

![maps_add_sun.png](../Images/Maps/maps_add_sun.png)

### Постобработка и эффекты

Для более точной настройки графики на карте добавьте `Sky and Fog Global Volume`.

Для этого в окне `Hierarcy` нажмите **ПКМ** на пустом месте и выберите `Volume` -> `Sky and Fog Global Volume`, затем сохраните сцену.

![maps_add_volume.png](../Images/Maps/maps_add_volume.png)

Для добавления постобработки и эффектов выберите объект `Sky and Fog Global Volume`, затем нажмите `Add Override` и выберите необходимые компоненты.

![maps_add_volume_override.png](../Images/Maps/maps_add_volume_override.png)

## Настройка карты

### Установка коллайдеров

> [!IMPORTANT]  
> Это важнейший этап в создании карты, без него у поверхностей не будет коллизий.

Для установки коллайдера нужно выбрать объект у которого должна быть коллизия и добавить ему один из коллайдеров.

Вы можете выбрать все объекты у которых должна быть коллизия и добавить к ним компонент `Mesh Collider`.

![maps_mesh_collider.png](../Images/Maps/maps_mesh_collider.png)

Однако имейте в виду, что это не самый лучший способ, так как обработка `Mesh Collider` требует больше вычислительных ресурсов.

Вы можете оптимизировать коллайдеры на карте, установив **прямоугольным** и **квадратным** объектам `Box Collider`.

**Столбам** и **деревьям** можете установить `Capsule Collider`.

Для более сложных поверхностей, к примеру **дорог с перепадами высот** или **ландшафта** используйте `Mesh Collider`.

### Установка поверхностей

Для установки доступны следующие типы поверхностей:
* road
* grass
* dirt
* gravel
* sand
* ice
* snow
* kerb

Они имеют разную степень зацепа и неровностей.

Можно использовать два метода установки типа поверхностей:
* Создать корневой объект с названием поверхности и поместить в него необходимые объекты  
  ![maps_surface_group.png](../Images/Maps/maps_surface_group.png)

* Указать тип поверхности для каждого объекта отдельно  
  ![maps_surface_single.png](../Images/Maps/maps_surface_single.png)

> [!NOTE]
> Указывать тип поверхности можно как на этапе создания модели (на пример в Blender) так и в самом Unity

### Установка точек вейпоинтов (точек телепорта)

Вы можете установить точки телепорта создав в корне сцены объект с именем `waypoints`.

![maps_waypoints.png](../Images/Maps/maps_waypoints.png)

Добавьте в объект `waypoints` **пустые объекты** и установите им необходимую позицию и вращение.

![maps_waypoints_add.png](../Images/Maps/maps_waypoints_add.png)

Называть эти объекты можете как угодно, их имя будет отображено в списке точек телепорта.

### [Опционально] Установка физических тел

Опционально вы можете добавить физические объекты, с которыми можно будет взаимодействовать.

Физические объекты должны находится в объекте `rigid_bodies`, который в свою очередь должен быть в корне сцены.

![maps_rigid_bodies.png](../Images/Maps/maps_rigid_bodies.png)

Выберите необходимые объекты, убедитесь, что у них установлен **любой коллайдер** и добавьте компонент `Rigid Body`.

![maps_rigid_bodies_component.png](../Images/Maps/maps_rigid_bodies_component.png)

### [Опционально] Контроллер времени суток

Если вы хотите добавить поддержку дня и ночи на карту, то сделать это можно с помощью следующих объектов:
* [Kino.Lights](#lights)
* [Kino.ToggleGroup.Day](#togglegroupday)
* [Kino.ToggleGroup.Night](#togglegroupnight)

#### Lights

Добавьте в эту этот объект источники света, которые должны быть включены ночью и отключены днём.

#### ToggleGroup.Day

Объекты в этой группе будут активны днём и не активны ночью.

#### ToggleGroup.Night

Объекты в этой группе будут активны ночью и не активны днём.

> [!IMPORTANT]  
> Оставьте активным только один объект `Kino.ToggleGroup.Day` или `Kino.ToggleGroup.Night`, в зависимости от дефолтного времени суток на карте.

## Оптимизация карты

Значительно повысить производительность на карте можно с помощью компонентов `LOD Group`.

Подробную информацию об этом компоненте можно найти [тут](https://docs.unity3d.com/Manual/class-LODGroup.html).

Так же для улучшения производительности рекомендуется выбрать все статические объекты и установить им флаг `Static`.

Выберите дороги, ландшафт, постройки и прочие статические объекты.

![maps_static_set.png](../Images/Maps/maps_static_set.png)

В диалоговом окне выберите `Yes, change children`.

![maps_static_set_dialog.png](../Images/Maps/maps_static_set_dialog.png)

# Сборка карты

Если у вас не открыт инструмент сборки, то сделать это можно через меню `Kino -> Maps tool`.

![maps_tool_open.png](../Images/Maps/maps_tool_open.png)

Можете перетащить **Maps tool** в любую зону, для удобства работы

![maps_tool_drag.png](../Images/Maps/maps_tool_drag.png)

Если вы видете вот такое сообщение, то нажмите на кнопку создания меты.

![maps_tool_create_meta.png](../Images/Maps/maps_tool_create_meta.png)

В поле **Build Folder** можете указать любую удобную папку. Я же указал путь к `KN_Base\maps` что бы готовые карты сразу устанавливались в игру.
![maps_tool_meta.png](../Images/Maps/maps_tool_meta.png)

В окне инструмента сборки выберите карты, которые хотите собрать используя поле `Selected to build`. После нажмите на кнопку `Build for ...`.

Так же из этого инструмента можно настроить данные об авторе, папку билда, а так же открыть настройки для каждой карты.
![maps_tool_main.png](../Images/Maps/maps_tool_main.png)

После завершения сборки карта будет помещена в указанную вами папку.